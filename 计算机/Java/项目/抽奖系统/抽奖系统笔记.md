# æŠ½å¥–ç³»ç»Ÿ



<img src="https://notetuchuang-1305953527.cos.ap-chengdu.myqcloud.com/images/%E6%8A%BD%E5%A5%96%E7%B3%BB%E7%BB%9F/%E6%B4%BB%E5%8A%A8%E7%BC%96%E6%8E%92.png" alt="æ´»åŠ¨ç¼–æ’">

## ä¸€ã€ç³»ç»Ÿæ¶æ„

<img src="https://notetuchuang-1305953527.cos.ap-chengdu.myqcloud.com/images/%E6%8A%BD%E5%A5%96%E7%B3%BB%E7%BB%9F/%E6%8A%BD%E5%A5%96%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.png" align="left" alt="æŠ½å¥–ç³»ç»Ÿæ¶æ„">



### 1.1 é¢†åŸŸæ¨¡å‹è®¾ç½®

<img src="https://notetuchuang-1305953527.cos.ap-chengdu.myqcloud.com/images/%E6%8A%BD%E5%A5%96%E7%B3%BB%E7%BB%9F/%E9%A2%86%E5%9F%9F%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1.png" align="left" alt="é¢†åŸŸæ¨¡å‹è®¾è®¡">



### 1.2 é¡¹ç›®å·¥ç¨‹ç›®å½•ç»“æ„

<img src="https://notetuchuang-1305953527.cos.ap-chengdu.myqcloud.com/images/%E6%8A%BD%E5%A5%96%E7%B3%BB%E7%BB%9F/%E9%A1%B9%E7%9B%AE%E5%B7%A5%E7%A8%8B%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84.png" align="left" alt="é¡¹ç›®ç›®å½•å·¥ç¨‹ç»“æ„"> 

lottery-domain æ˜¯ä¸“é—¨ç”¨äºå¼€å‘é¢†åŸŸæœåŠ¡çš„æ¨¡å—ï¼ŒåŒ…æ‹¬æŠ½å¥–ç­–ç•¥ã€æ´»åŠ¨é¢†åŸŸã€è§„åˆ™å¼•æ“ã€ç”¨æˆ·æœåŠ¡ç­‰éƒ½éœ€è¦åœ¨è¿™ä¸ªæ¨¡å—å®ç°å¯¹åº”çš„é¢†åŸŸåŠŸèƒ½ã€‚





### æ•°æ®åº“è®¾è®¡

+ æ´»åŠ¨é…ç½®ï¼Œactivityï¼šæä¾›æ´»åŠ¨çš„åŸºæœ¬é…ç½®

+ ç­–ç•¥é…ç½®ï¼Œstrategyï¼šç”¨äºé…ç½®æŠ½å¥–ç­–ç•¥ï¼Œæ¦‚ç‡ã€ç©æ³•ã€åº“å­˜ã€å¥–å“

+ ç­–ç•¥æ˜ç»†ï¼Œstrategy_detailï¼šæŠ½å¥–ç­–ç•¥çš„å…·ä½“æ˜ç»†é…ç½®
+ å¥–å“é…ç½®ï¼Œawardï¼šç”¨äºé…ç½®å…·ä½“å¯ä»¥å¾—åˆ°çš„å¥–å“
+ ç”¨æˆ·å‚ä¸æ´»åŠ¨è®°å½•è¡¨ï¼Œuser_take_activityï¼šæ¯ä¸ªç”¨æˆ·å‚ä¸æ´»åŠ¨éƒ½ä¼šè®°å½•ä¸‹ä»–çš„å‚ä¸ä¿¡æ¯ï¼Œæ—¶é—´ã€æ¬¡æ•°
+ ç”¨æˆ·æ´»åŠ¨å‚ä¸æ¬¡æ•°è¡¨ï¼Œuser_take_activity_countï¼šç”¨äºè®°å½•å½“å‰å‚ä¸äº†å¤šå°‘æ¬¡
+ ç”¨æˆ·ç­–ç•¥è®¡ç®—ç»“æœè¡¨ï¼Œuser_strategy_export_001~004ï¼šæœ€ç»ˆç­–ç•¥ç»“æœçš„ä¸€ä¸ªè®°å½•ï¼Œä¹Ÿå°±æ˜¯å¥–å“ä¸­å¥–ä¿¡æ¯çš„å†…å®¹

```mysql
create database lottery;

create table activity
(
    id            bigint auto_increment comment 'è‡ªå¢ID',
    activityId    bigint       null comment 'æ´»åŠ¨ID',
    activityName  varchar(64)  not null comment 'æ´»åŠ¨åç§°',
    activityDesc  varchar(128) null comment 'æ´»åŠ¨æè¿°',
    beginDateTime datetime     not null comment 'å¼€å§‹æ—¶é—´',
    endDateTime   datetime     not null comment 'ç»“æŸæ—¶é—´',
    stockCount    int          not null comment 'åº“å­˜',
    takeCount     int          null comment 'æ¯äººå¯å‚ä¸æ¬¡æ•°',
    state         int          null comment 'æ´»åŠ¨çŠ¶æ€ï¼šç¼–è¾‘ã€æå®¡ã€æ’¤å®¡ã€é€šè¿‡ã€è¿è¡Œã€æ‹’ç»ã€å…³é—­ã€å¼€å¯',
    creator       varchar(64)  not null comment 'åˆ›å»ºäºº',
    createTime    datetime     not null comment 'åˆ›å»ºæ—¶é—´',
    updateTime    datetime     not null comment 'ä¿®æ”¹æ—¶é—´',
    constraint activity_id_uindex
        unique (id)
)
    comment 'æ´»åŠ¨é…ç½®';

alter table activity
    add primary key (id);

-- auto-generated definition
create table award
(
    id           bigint(11) auto_increment comment 'è‡ªå¢ID'
        primary key,
    awardId      bigint                             null comment 'å¥–å“ID',
    awardType    int(4)                             null comment 'å¥–å“ç±»å‹ï¼ˆæ–‡å­—æè¿°ã€å…‘æ¢ç ã€ä¼˜æƒ åˆ¸ã€å®ç‰©å¥–å“æš‚æ— ï¼‰',
    awardCount   int                                null comment 'å¥–å“æ•°é‡',
    awardName    varchar(64)                        null comment 'å¥–å“åç§°',
    awardContent varchar(128)                       null comment 'å¥–å“å†…å®¹ã€Œæ–‡å­—æè¿°ã€Keyã€ç ã€',
    createTime   datetime default CURRENT_TIMESTAMP null comment 'åˆ›å»ºæ—¶é—´',
    updateTime   datetime default CURRENT_TIMESTAMP null comment 'updateTime'
)
    comment 'å¥–å“é…ç½®';

-- auto-generated definition
create table strategy
(
    id           bigint(11) auto_increment comment 'è‡ªå¢ID'
        primary key,
    strategyId   bigint(11)   not null comment 'ç­–ç•¥ID',
    strategyDesc varchar(128) null comment 'ç­–ç•¥æè¿°',
    strategyMode int(4)       null comment 'ç­–ç•¥æ–¹å¼ã€Œ1:å•é¡¹æ¦‚ç‡ã€2:æ€»ä½“æ¦‚ç‡ã€',
    grantType    int(4)       null comment 'å‘æ”¾å¥–å“æ–¹å¼ã€Œ1:å³æ—¶ã€2:å®šæ—¶[å«æ´»åŠ¨ç»“æŸ]ã€3:äººå·¥ã€',
    grantDate    datetime     null comment 'å‘æ”¾å¥–å“æ—¶é—´',
    extInfo      varchar(128) null comment 'æ‰©å±•ä¿¡æ¯',
    createTime   datetime     null comment 'åˆ›å»ºæ—¶é—´',
    updateTime   datetime     null comment 'ä¿®æ”¹æ—¶é—´',
    constraint strategy_strategyId_uindex
        unique (strategyId)
)
    comment 'ç­–ç•¥é…ç½®';

-- auto-generated definition
create table strategy_detail
(
    id         bigint(11) auto_increment comment 'è‡ªå¢ID'
        primary key,
    strategyId bigint(11)    not null comment 'ç­–ç•¥ID',
    awardId    bigint(11)    null comment 'å¥–å“ID',
    awardCount int           null comment 'å¥–å“æ•°é‡',
    awardRate  decimal(5, 2) null comment 'ä¸­å¥–æ¦‚ç‡',
    createTime datetime      null comment 'åˆ›å»ºæ—¶é—´',
    updateTime datetime      null comment 'ä¿®æ”¹æ—¶é—´'
) comment 'ç­–ç•¥æ˜ç»†';
alter table strategy_detail add awardSurplusCount int default 0 null comment 'å¥–å“å‰©ä½™åº“å­˜';
```



```mysql
create database lottery_01;

-- auto-generated definition
create table user_take_activity
(
    id           bigint    null,
    uId          tinytext  null,
    takeId       bigint    null,
    activityId   bigint    null,
    activityName tinytext  null,
    takeDate     timestamp null,
    takeCount    int       null,
    uuid         tinytext  null,
    createTime   timestamp null,
    updateTime   timestamp null
)
    comment 'ç”¨æˆ·å‚ä¸æ´»åŠ¨è®°å½•è¡¨';

-- auto-generated definition
create table user_take_activity_count
(
    id         bigint    null,
    uId        tinytext  null,
    activityId bigint    null,
    totalCount int       null,
    leftCount  int       null,
    createTime timestamp null,
    updateTime timestamp null
)
    comment 'ç”¨æˆ·æ´»åŠ¨å‚ä¸æ¬¡æ•°è¡¨';

-- auto-generated definition
create table user_strategy_export_001(id           bigint     null,uId          mediumtext null,activityId   bigint     null,orderId      bigint     null,strategyId   bigint     null,strategyType int        null,grantType    int        null,grantDate    timestamp  null,grantState   int        null,awardId      bigint     null,awardType    int        null,awardName    mediumtext null,awardContent mediumtext null,uuid         mediumtext null,createTime   timestamp  null,updateTime   timestamp  null) comment 'ç”¨æˆ·ç­–ç•¥è®¡ç®—ç»“æœè¡¨';
create table user_strategy_export_002(id           bigint     null,uId          mediumtext null,activityId   bigint     null,orderId      bigint     null,strategyId   bigint     null,strategyType int        null,grantType    int        null,grantDate    timestamp  null,grantState   int        null,awardId      bigint     null,awardType    int        null,awardName    mediumtext null,awardContent mediumtext null,uuid         mediumtext null,createTime   timestamp  null,updateTime   timestamp  null) comment 'ç”¨æˆ·ç­–ç•¥è®¡ç®—ç»“æœè¡¨';
create table user_strategy_export_003(id           bigint     null,uId          mediumtext null,activityId   bigint     null,orderId      bigint     null,strategyId   bigint     null,strategyType int        null,grantType    int        null,grantDate    timestamp  null,grantState   int        null,awardId      bigint     null,awardType    int        null,awardName    mediumtext null,awardContent mediumtext null,uuid         mediumtext null,createTime   timestamp  null,updateTime   timestamp  null) comment 'ç”¨æˆ·ç­–ç•¥è®¡ç®—ç»“æœè¡¨';
create table user_strategy_export_004(id           bigint     null,uId          mediumtext null,activityId   bigint     null,orderId      bigint     null,strategyId   bigint     null,strategyType int        null,grantType    int        null,grantDate    timestamp  null,grantState   int        null,awardId      bigint     null,awardType    int        null,awardName    mediumtext null,awardContent mediumtext null,uuid         mediumtext null,createTime   timestamp  null,updateTime   timestamp  null) comment 'ç”¨æˆ·ç­–ç•¥è®¡ç®—ç»“æœè¡¨';
```





mapperè¯­å¥

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.itedus.lottery.infrastructure.dao.IActivityDao">

    <sql id="selectFields">
        activity_id, activity_name, activity_desc, begin_date_time, end_date_time, stock_count, take_count, state, creator, create_time, update_time
    </sql>

    <insert id="insert" parameterType="cn.itedus.lottery.infrastructure.po.Activity">
        INSERT INTO lottery.activity
        (<include refid="selectFields" />)
        VALUES
        (#{activityId}, #{activityName}, #{activityDesc},#{beginDateTime}, #{endDateTime},
         #{stockCount}, #{takeCount}, #{state}, #{creator}, now(), now())
    </insert>

    <select id="queryActivityById" parameterType="java.lang.Long" resultType="cn.itedus.lottery.infrastructure.po.Activity">
        SELECT <include refid="selectFields" />
        FROM lottery.activity
        WHERE activity_id = #{activityId}
    </select>

</mapper>
```



## @PostConstruct

ç”¨`@PostConstruct`æ³¨è§£çš„æ–¹æ³•ä¼šåœ¨Springå®¹å™¨å¯åŠ¨æ—¶å°±æ‰§è¡Œï¼Œä¾‹å¦‚æå‰å°†æ•°æ®åº“ä¸­çš„æ•°æ®æ”¾å…¥åˆ°ä¸€ä¸ªé›†åˆä¸­



## äºŒã€åˆ†åº“åˆ†è¡¨

### 2.1 åˆ†åº“

åˆ†åº“ä¸»è¦è§£å†³çš„æ˜¯å¹¶å‘é‡å¤§çš„é—®é¢˜ã€‚å› ä¸ºå¹¶å‘é‡ä¸€æ—¦ä¸Šæ¥äº†ï¼Œé‚£ä¹ˆæ•°æ®åº“å°±å¯èƒ½ä¼šæˆä¸ºç“¶é¢ˆï¼Œå› ä¸ºæ•°æ®åº“çš„è¿æ¥æ•°æ˜¯æœ‰é™çš„ï¼Œè™½ç„¶å¯ä»¥è°ƒæ•´ï¼Œä½†æ˜¯ä¹Ÿä¸æ˜¯æ— é™è°ƒæ•´çš„ã€‚

æ‰€ä»¥ï¼Œå½“å½“ä½ çš„æ•°æ®åº“çš„è¯»æˆ–è€…å†™çš„QPSè¿‡é«˜ï¼Œå¯¼è‡´ä½ çš„æ•°æ®åº“è¿æ¥æ•°ä¸è¶³äº†çš„æ—¶å€™ï¼Œå°±éœ€è¦è€ƒè™‘åˆ†åº“äº†ï¼Œé€šè¿‡å¢åŠ æ•°æ®åº“å®ä¾‹çš„æ–¹å¼æ¥æä¾›æ›´å¤šçš„å¯ç”¨æ•°æ®åº“é“¾æ¥ï¼Œä»è€Œæå‡ç³»ç»Ÿçš„å¹¶å‘åº¦ã€‚

æ¯”è¾ƒå…¸å‹çš„åˆ†åº“çš„åœºæ™¯å°±æ˜¯æˆ‘ä»¬åœ¨åšå¾®æœåŠ¡æ‹†åˆ†çš„æ—¶å€™ï¼Œå°±ä¼šæŒ‰ç…§ä¸šåŠ¡è¾¹ç•Œï¼ŒæŠŠå„ä¸ªä¸šåŠ¡çš„æ•°æ®ä»ä¸€ä¸ªå•ä¸€çš„æ•°æ®åº“ä¸­æ‹†åˆ†å¼€ï¼Œåˆ†è¡¨æŠŠè®¢å•ã€ç‰©æµã€å•†å“ã€ä¼šå‘˜ç­‰å•ç‹¬æ”¾åˆ°å•ç‹¬çš„æ•°æ®åº“ä¸­ã€‚



### 2.2 åˆ†è¡¨

åˆ†åº“ä¸»è¦è§£å†³çš„æ˜¯å¹¶å‘é‡å¤§çš„é—®é¢˜ï¼Œé‚£åˆ†è¡¨å…¶å®ä¸»è¦è§£å†³çš„æ˜¯æ•°æ®é‡å¤§çš„é—®é¢˜ã€‚

å‡å¦‚ä½ çš„å•è¡¨æ•°æ®é‡éå¸¸å¤§ï¼Œå› ä¸ºå¹¶å‘ä¸é«˜ï¼Œæ•°æ®é‡è¿æ¥å¯èƒ½è¿˜å¤Ÿï¼Œä½†æ˜¯å­˜å‚¨å’ŒæŸ¥è¯¢çš„æ€§èƒ½é‡åˆ°äº†ç“¶é¢ˆäº†ï¼Œä½ åšäº†å¾ˆå¤šä¼˜åŒ–ä¹‹åè¿˜æ˜¯æ— æ³•æå‡æ•ˆç‡çš„æ—¶å€™ï¼Œå°±éœ€è¦è€ƒè™‘åšåˆ†è¡¨äº†ã€‚



### 2.3 æ¨ªå‘æ‹†åˆ†ï¼ˆæ°´å¹³æ‹†åˆ†ï¼‰å’Œçºµå‘æ‹†åˆ†ï¼ˆå‚ç›´æ‹†åˆ†ï¼‰

å•ä¸ªåº“å¤ªå¤§ï¼Œè¿™æ—¶æˆ‘ä»¬è¦çœ‹æ˜¯å› ä¸ºè¡¨å¤šè€Œå¯¼è‡´æ•°æ®å¤šï¼Œè¿˜æ˜¯å› ä¸ºå•å¼ è¡¨é‡Œé¢çš„æ•°æ®å¤šã€‚ å¦‚æœæ˜¯å› ä¸ºè¡¨å¤šè€Œæ•°æ®å¤šï¼Œä½¿ç”¨å‚ç›´åˆ‡åˆ†ï¼Œæ ¹æ®ä¸šåŠ¡åˆ‡åˆ†æˆä¸åŒçš„åº“ï¼Œå°†åŸæ¥ä¸€ä¸ªåº“ä¸­çš„è¡¨åˆ†æ•£åœ¨å¤šä¸ªåº“ä¸­ã€‚

å¦‚æœæ˜¯å› ä¸ºå•å¼ è¡¨çš„æ•°æ®é‡å¤ªå¤§ï¼Œè¿™æ—¶è¦ç”¨æ°´å¹³åˆ‡åˆ†ï¼Œå³æŠŠè¡¨çš„æ•°æ®æŒ‰æŸç§è§„åˆ™åˆ‡åˆ†æˆå¤šå¼ è¡¨ï¼Œç”šè‡³å¤šä¸ªåº“ä¸Šçš„å¤šå¼ è¡¨ã€‚ åˆ†åº“åˆ†è¡¨çš„é¡ºåºåº”è¯¥æ˜¯å…ˆå‚ç›´åˆ†ï¼Œåæ°´å¹³åˆ†ã€‚ å› ä¸ºå‚ç›´åˆ†æ›´ç®€å•ï¼Œæ›´ç¬¦åˆæˆ‘ä»¬å¤„ç†ç°å®ä¸–ç•Œé—®é¢˜çš„æ–¹å¼ã€‚



#### å‚ç›´æ‹†åˆ†

##### å‚ç›´åˆ†è¡¨

ä¹Ÿå°±æ˜¯â€œå¤§è¡¨æ‹†å°è¡¨â€ï¼ŒåŸºäºåˆ—å­—æ®µè¿›è¡Œçš„ã€‚ä¸€èˆ¬æ˜¯è¡¨ä¸­çš„å­—æ®µè¾ƒå¤šï¼Œå°†ä¸å¸¸ç”¨çš„ï¼Œ æ•°æ®è¾ƒå¤§ï¼Œé•¿åº¦è¾ƒé•¿ï¼ˆæ¯”å¦‚textç±»å‹å­—æ®µï¼‰çš„æ‹†åˆ†åˆ°â€œæ‰©å±•è¡¨â€œã€‚ ä¸€èˆ¬æ˜¯é’ˆå¯¹é‚£ç§å‡ ç™¾åˆ—çš„å¤§è¡¨ï¼Œä¹Ÿé¿å…æŸ¥è¯¢æ—¶ï¼Œæ•°æ®é‡å¤ªå¤§é€ æˆçš„â€œè·¨é¡µâ€é—®é¢˜ã€‚

##### å‚ç›´åˆ†åº“

å‚ç›´åˆ†åº“é’ˆå¯¹çš„æ˜¯ä¸€ä¸ªç³»ç»Ÿä¸­çš„ä¸åŒä¸šåŠ¡è¿›è¡Œæ‹†åˆ†ï¼Œæ¯”å¦‚ç”¨æˆ·Userä¸€ä¸ªåº“ï¼Œå•†å“Producetä¸€ä¸ªåº“ï¼Œè®¢å•Orderä¸€ä¸ªåº“ã€‚ åˆ‡åˆ†åï¼Œè¦æ”¾åœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæœåŠ¡å™¨ä¸Šã€‚ä¸ºä»€ä¹ˆï¼Ÿ æˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹ï¼Œä¸€ä¸ªè´­ç‰©ç½‘ç«™å¯¹å¤–æä¾›æœåŠ¡ï¼Œä¼šæœ‰ç”¨æˆ·ï¼Œå•†å“ï¼Œè®¢å•ç­‰çš„CRUDã€‚æ²¡æ‹†åˆ†ä¹‹å‰ï¼Œ å…¨éƒ¨éƒ½æ˜¯è½åˆ°å•ä¸€çš„åº“ä¸Šçš„ï¼Œè¿™ä¼šè®©æ•°æ®åº“çš„å•åº“å¤„ç†èƒ½åŠ›æˆä¸ºç“¶é¢ˆã€‚æŒ‰å‚ç›´åˆ†åº“åï¼Œå¦‚æœè¿˜æ˜¯æ”¾åœ¨ä¸€ä¸ªæ•°æ®åº“æœåŠ¡å™¨ä¸Šï¼Œ éšç€ç”¨æˆ·é‡å¢å¤§ï¼Œè¿™ä¼šè®©å•ä¸ªæ•°æ®åº“çš„å¤„ç†èƒ½åŠ›æˆä¸ºç“¶é¢ˆï¼Œè¿˜æœ‰å•ä¸ªæœåŠ¡å™¨çš„ç£ç›˜ç©ºé—´ï¼Œå†…å­˜ï¼Œtpsç­‰éå¸¸åƒç´§ã€‚ æ‰€ä»¥æˆ‘ä»¬è¦æ‹†åˆ†åˆ°å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·ä¸Šé¢çš„é—®é¢˜éƒ½è§£å†³äº†ï¼Œä»¥åä¹Ÿä¸ä¼šé¢å¯¹å•æœºèµ„æºé—®é¢˜ã€‚

æ•°æ®åº“ä¸šåŠ¡å±‚é¢çš„æ‹†åˆ†ï¼Œå’ŒæœåŠ¡çš„â€œæ²»ç†â€ï¼Œâ€œé™çº§â€æœºåˆ¶ç±»ä¼¼ï¼Œä¹Ÿèƒ½å¯¹ä¸åŒä¸šåŠ¡çš„æ•°æ®åˆ†åˆ«çš„è¿›è¡Œç®¡ç†ï¼Œç»´æŠ¤ï¼Œç›‘æ§ï¼Œæ‰©å±•ç­‰ã€‚ æ•°æ®åº“å¾€å¾€æœ€å®¹æ˜“æˆä¸ºåº”ç”¨ç³»ç»Ÿçš„ç“¶é¢ˆï¼Œè€Œæ•°æ®åº“æœ¬èº«å±äºâ€œæœ‰çŠ¶æ€â€çš„ï¼Œç›¸å¯¹äºWebå’Œåº”ç”¨æœåŠ¡å™¨æ¥è®²ï¼Œæ˜¯æ¯”è¾ƒéš¾å®ç°â€œæ¨ªå‘æ‰©å±•â€çš„ã€‚ æ•°æ®åº“çš„è¿æ¥èµ„æºæ¯”è¾ƒå®è´µä¸”å•æœºå¤„ç†èƒ½åŠ›ä¹Ÿæœ‰é™ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå‚ç›´åˆ†åº“ä¸€å®šç¨‹åº¦ä¸Šèƒ½å¤Ÿçªç ´IOã€è¿æ¥æ•°åŠå•æœºç¡¬ä»¶èµ„æºçš„ç“¶é¢ˆã€‚



#### æ°´å¹³æ‹†åˆ†

##### æ°´å¹³åˆ†è¡¨

é’ˆå¯¹æ•°æ®é‡å·¨å¤§çš„å•å¼ è¡¨ï¼ˆæ¯”å¦‚è®¢å•è¡¨ï¼‰ï¼ŒæŒ‰ç…§æŸç§è§„åˆ™ï¼ˆRANGE,HASHå–æ¨¡ç­‰ï¼‰ï¼Œåˆ‡åˆ†åˆ°å¤šå¼ è¡¨é‡Œé¢å»ã€‚ ä½†æ˜¯è¿™äº›è¡¨è¿˜æ˜¯åœ¨åŒä¸€ä¸ªåº“ä¸­ï¼Œæ‰€ä»¥åº“çº§åˆ«çš„æ•°æ®åº“æ“ä½œè¿˜æ˜¯æœ‰IOç“¶é¢ˆã€‚ä¸å»ºè®®é‡‡ç”¨ã€‚

##### æ°´å¹³åˆ†åº“åˆ†è¡¨

å°†å•å¼ è¡¨çš„æ•°æ®åˆ‡åˆ†åˆ°å¤šä¸ªæœåŠ¡å™¨ä¸Šå»ï¼Œæ¯ä¸ªæœåŠ¡å™¨å…·æœ‰ç›¸åº”çš„åº“ä¸è¡¨ï¼Œåªæ˜¯è¡¨ä¸­æ•°æ®é›†åˆä¸åŒã€‚ æ°´å¹³åˆ†åº“åˆ†è¡¨èƒ½å¤Ÿæœ‰æ•ˆçš„ç¼“è§£å•æœºå’Œå•åº“çš„æ€§èƒ½ç“¶é¢ˆå’Œå‹åŠ›ï¼Œçªç ´IOã€è¿æ¥æ•°ã€ç¡¬ä»¶èµ„æºç­‰çš„ç“¶é¢ˆã€‚



### 2.4 æŠ½å¥–ç³»ç»Ÿå®ç°å’Œä½¿ç”¨åˆ†åº“åˆ†è¡¨

+ å®šä¹‰è·¯ç”±æ³¨è§£
  + é¦–å…ˆæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªæ³¨è§£ï¼Œç”¨äºæ”¾ç½®åœ¨éœ€è¦è¢«æ•°æ®åº“è·¯ç”±çš„æ–¹æ³•ä¸Šã€‚
  + å®ƒçš„ä½¿ç”¨æ–¹å¼æ˜¯é€šè¿‡æ–¹æ³•é…ç½®æ³¨è§£ï¼Œå°±å¯ä»¥è¢«æˆ‘ä»¬æŒ‡å®šçš„ AOP åˆ‡é¢è¿›è¡Œæ‹¦æˆªï¼Œæ‹¦æˆªåè¿›è¡Œç›¸åº”çš„æ•°æ®åº“è·¯ç”±è®¡ç®—å’Œåˆ¤æ–­ï¼Œå¹¶åˆ‡æ¢åˆ°ç›¸åº”çš„æ“ä½œæ•°æ®æºä¸Š



## ä¸‰ã€æŠ½å¥–ç­–ç•¥é¢†åŸŸ

### 3.1 éœ€æ±‚

åœ¨ä¸€åœºè¥é”€æŠ½å¥–æ´»åŠ¨ç©æ³•ä¸­ï¼Œè¿è¥äººå‘˜é€šå¸¸ä¼šé…ç½®ä»¥è½¬ç›˜ã€ç›²ç›’ç­‰å±•ç°å½¢å¼çš„æŠ½å¥–ç©æ³•ã€‚ä¾‹å¦‚åœ¨è½¬ç›˜ä¸­é…ç½®12ä¸ªå¥–å“ï¼Œæ¯ä¸ªå¥–å“é…ç½®ä¸åŒçš„ä¸­å¥–æ¦‚ç‡ï¼Œå½“1ä¸ªå¥–å“è¢«æŠ½ç©ºäº†ä»¥åï¼Œé‚£ä¹ˆå†æŠ½å¥–æ—¶ï¼Œæ˜¯å‰©ä½™çš„å¥–å“æ€»æ¦‚ç‡å‡åŒ€åˆ†é…åœ¨11ä¸ªå¥–å“ä¸Šï¼Œè¿˜æ˜¯ä¿æŒå‰©ä½™11ä¸ªå¥–å“çš„ä¸­å¥–æ¦‚ç‡ï¼Œå¦‚æœæŠ½åˆ°ä¸ºç©ºçš„å¥–å“åˆ™è¡¨ç¤ºæœªä¸­å¥–ã€‚å…¶å®è¿™ä¸¤ç§æ–¹å¼åœ¨å®é™…çš„è¿è¥è¿‡ç¨‹ä¸­éƒ½ä¼šæœ‰æ‰€é€‰å–ï¼Œä¸»è¦æ˜¯ä¸ºäº†é…åˆä¸åŒçš„ç©æ³•



### 3.2 è®¾è®¡

é‚£ä¹ˆæˆ‘ä»¬åœ¨åšè¿™æ ·çš„æŠ½å¥–é¢†åŸŸæ¨¡å—è®¾è®¡æ—¶ï¼Œå°±è¦è€ƒè™‘åˆ°åº“è¡¨ä¸­è¦æœ‰å¯¹åº”çš„å­—æ®µæ¥åŒºåˆ†å½“å‰è¿è¥é€‰æ‹©çš„æ˜¯ä»€ä¹ˆæ ·çš„æŠ½å¥–ç­–ç•¥ã€‚é‚£ä¹ˆåœ¨å¼€å‘å®ç°ä¸Šä¹Ÿä¼šç”¨åˆ°å¯¹åº”çš„`ç­–ç•¥æ¨¡å¼`çš„ä½¿ç”¨ï¼Œä¸¤ç§æŠ½å¥–ç®—æ³•å¯ä»¥ç®—æ˜¯ä¸åŒçš„æŠ½å¥–ç­–ç•¥ï¼Œæœ€ç»ˆæä¾›ç»Ÿä¸€çš„æ¥å£åŒ…è£…æ»¡è¶³ä¸åŒçš„æŠ½å¥–åŠŸèƒ½è°ƒç”¨ã€‚

<img src="https://notetuchuang-1305953527.cos.ap-chengdu.myqcloud.com/images/%E6%8A%BD%E5%A5%96%E7%B3%BB%E7%BB%9F/%E6%8A%BD%E5%A5%96%E7%AD%96%E7%95%A5%E8%A1%A8%E8%AE%BE%E8%AE%A1.png" align="left" alt="æŠ½å¥–ç­–ç•¥è¡¨è®¾è®¡">

- åœ¨åº“è¡¨è®¾è®¡ä¸Šæˆ‘ä»¬æŠŠæŠ½å¥–éœ€è¦çš„ç­–ç•¥é…ç½®å’Œç­–ç•¥æ˜ç»†ï¼Œå®ƒä»¬çš„å…³ç³»æ˜¯`1vn`ã€‚
- å¦å¤–ä¸ºäº†è®©æŠ½å¥–ç­–ç•¥æˆä¸ºå¯ä»¥ç‹¬ç«‹é…ç½®å’Œä½¿ç”¨çš„é¢†åŸŸæ¨¡å—ï¼Œåœ¨ç­–ç•¥è¡¨ç”¨ä¸å¼•å…¥æ´»åŠ¨IDä¿¡æ¯çš„é…ç½®ã€‚å› ä¸ºåœ¨å»ºè®¾é¢†åŸŸæ¨¡å—çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè®©è¿™éƒ¨åˆ†çš„é¢†åŸŸå®ç°å…·æœ‰å¯ç‹¬ç«‹è¿è¡Œçš„ç‰¹æ€§ï¼Œä¸è®©å®ƒè¢«ä¸šåŠ¡é€»è¾‘æ±¡æŸ“ï¼Œå®ƒåªæ˜¯ä¸€ç§æ— ä¸šåŠ¡é€»è¾‘çš„é€šç”¨å…±æ€§çš„åŠŸèƒ½é¢†åŸŸæ¨¡å—ï¼Œåœ¨ä¸šåŠ¡ç»„åˆçš„è¿‡ç¨‹ä¸­å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½é¢†åŸŸæä¾›çš„æ ‡å‡†æ¥å£ã€‚
- é€šè¿‡è¿™æ ·çš„è®¾è®¡å®ç°ï¼Œå°±å¯ä»¥æ»¡è¶³äºä¸åŒä¸šåŠ¡åœºæ™¯çš„çµæ´»è°ƒç”¨ï¼Œä¾‹å¦‚ï¼šæœ‰äº›ä¸šåŠ¡åœºæ™¯æ˜¯éœ€è¦ä½ ç›´æ¥æ¥è¿›è¡ŒæŠ½å¥–åé¦ˆä¸­å¥–ä¿¡æ¯å‘é€ç»™ç”¨æˆ·ï¼Œä½†è¿˜æœ‰ä¸€äº›å› ä¸ºç”¨æˆ·ä¸‹å•æ”¯ä»˜æ‰æ»¡è¶³æŠ½å¥–æ¡ä»¶çš„åœºæ™¯å¯¹åº”çš„å¥–å“æ˜¯éœ€è¦å»¶æ—¶åˆ°è´¦çš„ï¼Œé¿å…ç”¨æˆ·åœ¨ä¸‹å•ååˆè¿›è¡Œé€€å•ï¼Œè¿™æ ·é€ æˆäº†åˆ·å•çš„é£é™©ã€‚``



> å…¶ä¸­ç­–ç•¥æ¨¡å¼ç”¨äºåœ¨æœ‰å¤šé‡ç®—æ³•è§£å†³æŸä¸€é—®é¢˜æ—¶ï¼Œå…è®¸ç”¨æˆ·ä»è¿™äº›ç®—æ³•ä¸­é€‰ä¸€ä¸ªç®—æ³•è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒåŒæ—¶å¯ä»¥æ–¹ä¾¿åœ°æ›´æ¢ç®—æ³•æˆ–è€…å¢åŠ æ–°çš„ç®—æ³•ï¼Œé€šè¿‡ç»§æ‰¿å’Œå¤šæ€çš„æœºåˆ¶å®ç°å¯¹ç®—æ³•çš„ä½¿ç”¨å’Œç®¡ç†ã€‚
>
> ä¾‹å¦‚æƒ³è¦å»å…¶ä»–åŸå¸‚ï¼Œå¯ä»¥é€šè¿‡åé£æœºã€åšé«˜é“ä»¥åŠåå¤§å·´ç­‰äº¤é€šæ–¹å¼ï¼Œä½†æ˜¯å¯èƒ½ä¼šå› ä¸ºæ—¶é—´ã€é‡‘é’±ç­‰è§’åº¦é€‰å–ä¸åŒçš„äº¤é€šæ–¹å¼



### 3.3 æŠ½å¥–ç®—æ³•å®ç°

+ **æ€»ä½“æ¦‚ç‡**ï¼šå¦‚æœAå¥–å“æŠ½ç©ºåï¼ŒBå’ŒCå¥–å“çš„æ¦‚ç‡æŒ‰ç…§ `3:5` å‡åˆ†ï¼Œç›¸å½“äºBå¥–å“ä¸­å¥–æ¦‚ç‡ç”± `0.3` å‡ä¸º `0.375`

+ **å•é¡¹æ¦‚ç‡**ï¼šå¦‚æœAå¥–å“æŠ½ç©ºåï¼ŒBå’ŒCä¿æŒç›®å‰ä¸­å¥–æ¦‚ç‡ï¼Œç”¨æˆ·æŠ½å¥–æ‰”æœ‰20%ä¸­ä¸ºAï¼Œå› Aåº“å­˜æŠ½ç©ºåˆ™ç»“æœå±•ç¤ºä¸ºæœªä¸­å¥–ã€‚*ä¸ºäº†è¿è¥æˆæœ¬ï¼Œé€šå¸¸è¿™ç§æƒ…å†µçš„ä½¿ç”¨çš„æ¯”è¾ƒå¤š*



## å››ã€æŠ½å¥–æµç¨‹

### 4.1 éœ€æ±‚

æŠ½å¥–æµç¨‹åŒ…æ‹¬ï¼š

+ ï¼ˆå›ºå®šï¼‰æ ¹æ®å…¥å‚ç­–ç•¥IDè·å–æŠ½å¥–ç­–ç•¥é…ç½®

+ ï¼ˆå›ºå®šï¼‰æ ¡éªŒå’Œå¤„ç†æŠ½å¥–ç­–ç•¥çš„æ•°æ®åˆå§‹åŒ–åˆ°å†…å­˜
+ ï¼ˆå¯å˜ï¼‰è·å–é‚£äº›è¢«æ’é™¤æ‰çš„æŠ½å¥–åˆ—è¡¨ï¼Œè¿™äº›å¥–å“å¯èƒ½æ˜¯å·²ç»å¥–å“åº“å­˜ä¸ºç©ºï¼Œæˆ–è€…å› ä¸ºé£æ§ç­–ç•¥ä¸èƒ½ç»™è¿™ä¸ªç”¨æˆ·è–…ç¾Šæ¯›çš„å¥–å“
+ ï¼ˆå¯å˜ï¼‰æ‰§è¡ŒæŠ½å¥–ç®—æ³•
+ ï¼ˆå›ºå®šï¼‰åŒ…è£…ä¸­å¥–ç»“æœ



### 4.2 è®¾è®¡

ä½¿ç”¨`æ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼`ä¼˜åŒ–ç±» `DrawExecImpl` æŠ½å¥–è¿‡ç¨‹æ–¹æ³•å®ç°ï¼Œä¸»è¦ä»¥æŠ½è±¡ç±» `AbstractDrawBase` ç¼–æ’å®šä¹‰æµç¨‹ï¼Œå®šä¹‰æŠ½è±¡æ–¹æ³•ç”±ç±» `DrawExecImpl` åšå…·ä½“å®ç°çš„æ–¹å¼è¿›è¡Œå¤„ç†

åœ¨çˆ¶ç±»æ–¹æ³•ä¸­éœ€è¦å®šä¹‰æ ¹æ®å…¥å‚ç­–ç•¥IDè·å–æŠ½å¥–ç­–ç•¥é…ç½®ã€æ ¡éªŒå’Œå¤„ç†æŠ½å¥–ç­–ç•¥çš„æ•°æ®åˆå§‹åŒ–åˆ°å†…å­˜å’ŒåŒ…è£…ä¸­å¥–ç»“æœè¿™ä¸‰ä¸ªæ­¥éª¤çš„å®ç°ï¼Œè€Œè·å–é‚£äº›è¢«æ’é™¤æ‰çš„æŠ½å¥–åˆ—è¡¨ã€æ‰§è¡ŒæŠ½å¥–ç®—æ³•è¿™ä¸¤ä¸ªæ­¥éª¤çš„å®ç°éœ€è¦äº¤ç»™å­ç±»æ¥å®ç°



> æ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼ï¼Œé€‚ç”¨äºæŸä¸ªæ–¹æ³•çš„å®ç°éœ€è¦å¤šä¸ªæ­¥éª¤ï¼ˆä¸ºé“¶è¡Œè®¾è®¡åˆ©æ¯è®¡ç®—æ¨¡å—ï¼‰ï¼Œå…¶ä¸­æŸäº›æ­¥éª¤æ˜¯å›ºå®šçš„ï¼ˆè´¦å·å’Œå¯†ç éªŒè¯ã€åˆ©æ¯è®¡ç®—ç»“æœçš„æ˜¾ç¤ºï¼‰ï¼Œè€Œæœ‰ä¸€äº›æ­¥éª¤ä¸å›ºå®šï¼ˆæ ¹æ®ä¸åŒç±»å‹çš„ç”¨æˆ·ç”¨ä¸åŒçš„æ–¹å¼è®¡ç®—åˆ©æ¯ï¼‰ï¼Œå­˜åœ¨å¯å˜æ€§ã€‚
>
> åœ¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼ä¸­å°†å®ç°åŠŸèƒ½çš„æ¯ä¸€ä¸ªæ­¥éª¤å¯¹åº”çš„æ–¹æ³•ç§°ä¸ºåŸºæœ¬æ–¹æ³•ï¼ˆä¾‹å¦‚ä¸Šé¢è´¦å·å’Œå¯†ç éªŒè¯ã€åˆ©æ¯è®¡ç®—ç»“æœçš„æ˜¾ç¤ºå’Œæ ¹æ®ä¸åŒç±»å‹çš„ç”¨æˆ·ç”¨ä¸åŒçš„æ–¹å¼è®¡ç®—åˆ©æ¯ï¼‰ï¼Œè€Œå°†è°ƒç”¨è¿™äº›åŸºæœ¬æ–¹æ³•åŒæ—¶å®šä¹‰åŸºæœ¬æ–¹æ³•çš„æ‰§è¡Œæ¬¡åºçš„æ–¹æ³•ç§°ä¸ºæ¨¡æ¿æ–¹æ³•ï¼ˆä¾‹å¦‚é“¶è¡Œåˆ©æ¯è®¡ç®—æ¨¡å—æ–¹æ³•ï¼‰ã€‚
>
> åœ¨é“¶è¡Œåˆ©æ¯è®¡ç®—æ¨¡å—ä¸­ï¼Œå°†åˆ©æ¯è®¡ç®—æ¨¡å—ç±»ä¸­å°†è´¦å·å’Œå¯†ç éªŒè¯ã€åˆ©æ¯è®¡ç®—ç»“æœçš„æ˜¾ç¤ºè¿™ä¸¤ä¸ªåŸºæœ¬æ–¹æ³•çš„å®ç°æ”¾åœ¨çˆ¶ç±»ä¸­ï¼Œè€Œå¯¹äºåŸºæœ¬æ–¹æ³•æ ¹æ®ä¸åŒç±»å‹çš„ç”¨æˆ·ç”¨ä¸åŒçš„æ–¹å¼è®¡ç®—åˆ©åªæ˜¯åœ¨çˆ¶ç±»ä¸­æä¾›ä¸€ä¸ªå£°æ˜ï¼Œå…·ä½“çš„å®ç°å°†æ”¾åœ¨å­ç±»ä¸­å»è¿›è¡Œã€‚



## äº”ã€å‘å¥–é¢†åŸŸ

### 5.1 éœ€æ±‚

æ ¹æ®ç”¨æˆ·è·å–å¥–å“ä¸åŒï¼Œå‘é€ä¸åŒçš„å¥–å“ï¼Œä¾‹å¦‚é‚®å¯„å•†å“ã€å…‘æ¢ç ä»¥åŠä¼˜æƒ åˆ¸ç­‰



### 5.2 è®¾è®¡

å…³äº award å‘å¥–é¢†åŸŸä¸­ä¸»è¦çš„æ ¸å¿ƒå®ç°åœ¨äº service ä¸­çš„ä¸¤å—åŠŸèƒ½é€»è¾‘å®ç°ï¼Œåˆ†åˆ«æ˜¯ï¼š`goods å•†å“å¤„ç†`ã€`factory å·¥å‚ğŸ­`

goodsï¼šåŒ…è£…é€‚é…å„ç±»å¥–å“çš„å‘æ”¾é€»è¾‘ï¼Œè™½ç„¶æˆ‘ä»¬ç›®å‰çš„æŠ½å¥–ç³»ç»Ÿä»…æ˜¯ç»™ç”¨æˆ·è¿”å›ä¸€ä¸ªä¸­å¥–æè¿°ï¼Œä½†åœ¨å®é™…çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œæ˜¯çœŸå®çš„è°ƒç”¨ä¼˜æƒ åˆ¸ã€å…‘æ¢ç ã€ç‰©æµå‘è´§ç­‰æ“ä½œï¼Œè€Œè¿™äº›å†…å®¹ç»è¿‡å°è£…åå°±å¯ä»¥åœ¨è‡ªå·±çš„å•†å“ç±»ä¸‹å®ç°äº†ã€‚

factoryï¼šå·¥å‚æ¨¡å¼é€šè¿‡è°ƒç”¨æ–¹æä¾›å‘å¥–ç±»å‹ï¼Œè¿”å›å¯¹åº”çš„å‘å¥–æœåŠ¡ã€‚é€šè¿‡è¿™æ ·ç”±å…·ä½“çš„å­ç±»å†³å®šè¿”å›ç»“æœï¼Œå¹¶åšç›¸åº”çš„ä¸šåŠ¡å¤„ç†ã€‚ä»è€Œä¸è‡³äºè®©é¢†åŸŸå±‚åŒ…è£…å¤ªå¤šçš„é¢‘ç¹å˜åŒ–çš„ä¸šåŠ¡å±æ€§ï¼Œå› ä¸ºå¦‚æœä½ çš„æ ¸å¿ƒåŠŸèƒ½åŸŸæ˜¯åœ¨åšä¸šåŠ¡é€»è¾‘å°è£…ï¼Œå°±ä¼šå°±ä¼šå˜å¾—éå¸¸åºå¤§ä¸”æ··ä¹±ã€‚



## å…­ã€æ´»åŠ¨é¢†åŸŸçš„é…ç½®ä¸çŠ¶æ€

### 6.1 éœ€æ±‚

å¼€å‘æ´»åŠ¨é¢†åŸŸéƒ¨åˆ†åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼šæ´»åŠ¨åˆ›å»ºã€æ´»åŠ¨çŠ¶æ€å˜æ›´ã€‚ä¸»è¦ä»¥ domain é¢†åŸŸå±‚ä¸‹æ·»åŠ  activity ä¸ºä¸»ï¼Œå¹¶åœ¨å¯¹åº”çš„ service ä¸­æ·»åŠ 

+ deploy(åˆ›å»ºæ´»åŠ¨)
  + åŠ¨çš„åˆ›å»ºæ“ä½œä¸»è¦åŒ…æ‹¬ï¼šæ·»åŠ æ´»åŠ¨é…ç½®ã€æ·»åŠ å¥–å“é…ç½®ã€æ·»åŠ ç­–ç•¥é…ç½®ã€æ·»åŠ ç­–ç•¥æ˜ç»†é…ç½®ï¼Œè¿™äº›éƒ½æ˜¯åœ¨åŒä¸€ä¸ªæ³¨è§£äº‹åŠ¡é…ç½®ä¸‹è¿›è¡Œå¤„ç† `@Transactional(rollbackFor = Exception.class)`
+ partake(é¢†å–æ´»åŠ¨ï¼Œå¾…å¼€å‘)
+ stateflow(çŠ¶æ€æµè½¬) ä¸‰ä¸ªæ¨¡å—



### 6.2 è®¾è®¡

æ´»åŠ¨åˆ›å»ºçš„æ“ä½œä¸»è¦ä¼šç”¨åˆ°äº‹åŠ¡ï¼Œå› ä¸ºæ´»åŠ¨ç³»ç»Ÿæä¾›ç»™è¿è¥åå°åˆ›å»ºæ´»åŠ¨æ—¶ï¼Œéœ€è¦åŒ…æ‹¬ï¼šæ´»åŠ¨ä¿¡æ¯ã€å¥–å“ä¿¡æ¯ã€ç­–ç•¥ä¿¡æ¯ã€ç­–ç•¥æ˜ç»†ä»¥åŠå…¶ä»–é¢å¤–æ‰©å±•çš„å†…å®¹ï¼Œè¿™äº›ä¿¡æ¯éƒ½éœ€è¦åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸‹è¿›è¡Œè½åº“ã€‚

æ´»åŠ¨çŠ¶æ€çš„å®¡æ ¸ï¼Œã€1ç¼–è¾‘ã€2æå®¡ã€3æ’¤å®¡ã€4é€šè¿‡ã€5è¿è¡Œ(å®¡æ ¸é€šè¿‡åworkeræ‰«æçŠ¶æ€)ã€6æ‹’ç»ã€7å…³é—­ã€8å¼€å¯ã€‘ï¼Œè¿™é‡Œæˆ‘ä»¬ä¼šç”¨åˆ°è®¾è®¡æ¨¡å¼ä¸­çš„`çŠ¶æ€æ¨¡å¼`è¿›è¡Œå¤„ç†ã€‚

<img src="https://notetuchuang-1305953527.cos.ap-chengdu.myqcloud.com/images/%E6%8A%BD%E5%A5%96%E7%B3%BB%E7%BB%9F/%E6%8A%BD%E5%A5%96%E6%B4%BB%E5%8A%A8%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E5%9B%BE.png" align="left" alt="æŠ½å¥–æ´»åŠ¨çŠ¶æ€è½¬æ¢">



> çŠ¶æ€æ¨¡å¼ç”¨äºè§£å†³ç³»ç»Ÿä¸­å¤æ‚å¯¹è±¡çš„çŠ¶æ€è½¬æ¢ä»¥åŠä¸åŒçŠ¶æ€ä¸‹è¡Œä¸ºçš„å°è£…é—®é¢˜ã€‚å½“ç³»ç»Ÿä¸­çš„æŸä¸ªå¯¹è±¡å­˜åœ¨å¤šä¸ªçŠ¶æ€ï¼Œè¿™äº›çŠ¶æ€ä¹‹é—´å¯ä»¥è¿›è¡Œè½¬æ¢ï¼Œè€Œä¸”å¯¹è±¡åœ¨ä¸åŒçŠ¶æ€ä¸‹è¡Œä¸ºä¸ç›¸åŒæ—¶å¯ä»¥ä½¿ç”¨çŠ¶æ€æ¨¡å¼ã€‚



## ä¸ƒã€IDç”Ÿæˆç­–ç•¥é¢†åŸŸå¼€å‘ï¼ˆæ”¯æ’‘åŸŸï¼‰

å…³äº ID çš„ç”Ÿæˆå› ä¸ºæœ‰ä¸‰ç§ä¸åŒ ID ç”¨äºåœ¨ä¸åŒçš„åœºæ™¯ä¸‹ï¼›

- è®¢å•å·ï¼šå”¯ä¸€ã€å¤§é‡ã€è®¢å•åˆ›å»ºæ—¶ä½¿ç”¨ã€åˆ†åº“åˆ†è¡¨
- æ´»åŠ¨å·ï¼šå”¯ä¸€ã€å°‘é‡ã€æ´»åŠ¨åˆ›å»ºæ—¶ä½¿ç”¨ã€å•åº“å•è¡¨
- ç­–ç•¥å·ï¼šå”¯ä¸€ã€å°‘é‡ã€æ´»åŠ¨åˆ›å»ºæ—¶ä½¿ç”¨ã€å•åº“å•è¡¨ã€



ä½¿ç”¨ç­–ç•¥æ¨¡å¼æ ¹æ®ç”¨æˆ·éœ€æ±‚æ¥é€‰æ‹©å¯¹åº”çš„IDç”Ÿæˆç­–ç•¥




## å…«ã€åˆ†åº“åˆ†è¡¨æ’ä»¶

### 8.1 ä½¿ç”¨æŠ€æœ¯

+ AOPï¼Œéœ€è¦ç»™ä½¿ç”¨æ•°æ®åº“è·¯ç”±çš„æ–¹æ³•åšä¸Šæ ‡è®°ï¼Œä¾¿äºå¤„ç†åˆ†åº“åˆ†è¡¨é€»è¾‘ã€‚åŒ…å«äº†æ•°æ®åº“è·¯ç”±è®¡ç®—ã€æ‰°åŠ¨å‡½æ•°åŠ å¼ºæ•£åˆ—ã€è®¡ç®—åº“è¡¨ç´¢å¼•ã€è®¾ç½®åˆ° ThreadLocal ä¼ é€’æ•°æ®æº
+ æ•°æ®æºçš„åˆ‡æ¢æ“ä½œï¼Œæ—¢ç„¶æœ‰åˆ†åº“é‚£ä¹ˆå°±ä¼šæ¶‰åŠåœ¨å¤šä¸ªæ•°æ®æºé—´è¿›è¡Œé“¾æ¥åˆ‡æ¢ï¼Œä»¥ä¾¿æŠŠæ•°æ®åˆ†é…ç»™ä¸åŒçš„æ•°æ®åº“ã€‚
  + åœ¨ç»“åˆ SpringBoot å¼€å‘çš„ Starter ä¸­ï¼Œéœ€è¦æä¾›ä¸€ä¸ª DataSource çš„å®ä¾‹åŒ–å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡æˆ‘ä»¬å°±æ”¾åœ¨DataSourceAutoConfig æ¥å®ç°ï¼Œå¹¶ä¸”è¿™é‡Œæä¾›çš„æ•°æ®æºæ˜¯å¯ä»¥åŠ¨æ€å˜æ¢çš„ï¼Œä¹Ÿå°±æ˜¯æ”¯æŒåŠ¨æ€åˆ‡æ¢æ•°æ®æºã€‚

+ æ•°æ®åº“è¡¨å¯»å€æ“ä½œï¼Œä¸€æ¡æ•°æ®åˆ†é…åˆ°å“ªä¸ªæ•°æ®åº“ï¼Œå“ªå¼ è¡¨ï¼Œéƒ½éœ€è¦è¿›è¡Œç´¢å¼•è®¡ç®—ã€‚åœ¨æ–¹æ³•è°ƒç”¨çš„è¿‡ç¨‹ä¸­æœ€ç»ˆé€šè¿‡ ThreadLocal è®°å½•
+ ä¸ºäº†èƒ½è®©æ•°æ®å‡åŒ€çš„åˆ†é…åˆ°ä¸åŒçš„åº“è¡¨ä¸­å»ï¼Œè¿˜éœ€è¦è€ƒè™‘å¦‚ä½•è¿›è¡Œæ•°æ®æ•£åˆ—çš„æ“ä½œï¼Œä¸èƒ½åˆ†åº“åˆ†è¡¨åï¼Œè®©æ•°æ®éƒ½é›†ä¸­åœ¨æŸä¸ªåº“çš„æŸä¸ªè¡¨ï¼Œè¿™æ ·å°±å¤±å»äº†åˆ†åº“åˆ†è¡¨çš„æ„ä¹‰ã€‚



### 8.2 è®¾è®¡å®ç°

#### å®šä¹‰è·¯ç”±æ³¨è§£

é¦–å…ˆæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªæ³¨è§£ï¼Œç”¨äºæ”¾ç½®åœ¨éœ€è¦è¢«æ•°æ®åº“è·¯ç”±çš„æ–¹æ³•ä¸Šã€‚

```java
@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE, ElementType.METHOD})
public @interface DBRouter {

    String key() default "";

}
```

å®ƒçš„ä½¿ç”¨æ–¹å¼æ˜¯é€šè¿‡æ–¹æ³•é…ç½®æ³¨è§£ï¼Œå°±å¯ä»¥è¢«æˆ‘ä»¬æŒ‡å®šçš„ AOP åˆ‡é¢è¿›è¡Œæ‹¦æˆªï¼Œæ‹¦æˆªåè¿›è¡Œç›¸åº”çš„æ•°æ®åº“è·¯ç”±è®¡ç®—å’Œåˆ¤æ–­ï¼Œå¹¶åˆ‡æ¢åˆ°ç›¸åº”çš„æ“ä½œæ•°æ®æºä¸Šã€‚

```java
@Mapper
public interface IUserDao {

     @DBRouter(key = "userId")
     User queryUserInfoByUserId(User req);

     @DBRouter(key = "userId")
     void insertUser(User req);

}
```



#### è§£æè·¯ç”±é…ç½®

<img src="https://notetuchuang-1305953527.cos.ap-chengdu.myqcloud.com/images/%E6%8A%BD%E5%A5%96%E7%B3%BB%E7%BB%9F/%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE.png" align="left" alt="å¤šæ•°æ®æºè·¯ç”±é…ç½®">



**æ•°æ®æºé…ç½®æå–**

```java
@Override
public void setEnvironment(Environment environment) {
    String prefix = "router.jdbc.datasource.";    

    dbCount = Integer.valueOf(environment.getProperty(prefix + "dbCount"));
    tbCount = Integer.valueOf(environment.getProperty(prefix + "tbCount"));    

    String dataSources = environment.getProperty(prefix + "list");
    for (String dbInfo : dataSources.split(",")) {
        Map<String, Object> dataSourceProps = PropertyUtil.handle(environment, prefix + dbInfo, Map.class);
        dataSourceMap.put(dbInfo, dataSourceProps);
    }
}
```

> + prefixï¼Œæ˜¯æ•°æ®æºé…ç½®çš„å¼€å¤´ä¿¡æ¯ï¼Œä½ å¯ä»¥è‡ªå®šä¹‰éœ€è¦çš„å¼€å¤´å†…å®¹ã€‚
> + dbCountã€tbCountã€dataSourcesã€dataSourcePropsï¼Œéƒ½æ˜¯å¯¹é…ç½®ä¿¡æ¯çš„æå–ï¼Œå¹¶å­˜æ”¾åˆ° dataSourceMap ä¸­ä¾¿äºåç»­ä½¿ç”¨ã€‚



#### æ•°æ®æºåˆ‡æ¢

ä¸Šé¢é…ç½®å¥½æ•°æ®æºåï¼Œå¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œåˆ‡æ¢

åœ¨ç»“åˆ SpringBoot å¼€å‘çš„ Starter ä¸­ï¼Œéœ€è¦æä¾›ä¸€ä¸ª DataSource çš„å®ä¾‹åŒ–å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡æˆ‘ä»¬å°±æ”¾åœ¨ DataSourceAutoConfig æ¥å®ç°ï¼Œå¹¶ä¸”è¿™é‡Œæä¾›çš„æ•°æ®æºæ˜¯å¯ä»¥åŠ¨æ€å˜æ¢çš„ï¼Œä¹Ÿå°±æ˜¯æ”¯æŒåŠ¨æ€åˆ‡æ¢æ•°æ®æºã€‚

åˆ›å»ºæ•°æ®æº

```Java
@Bean
public DataSource dataSource() {
    // åˆ›å»ºæ•°æ®æºï¼Œé…ç½®æ•°æ®æºç›¸å…³ä¿¡æ¯ï¼ˆç”¨æˆ·åï¼Œå¯†ç ï¼Œurlï¼‰
    Map<Object, Object> targetDataSources = new HashMap<>();
    for (String dbInfo : dataSourceMap.keySet()) {
        Map<String, Object> objMap = dataSourceMap.get(dbInfo);
        targetDataSources.put(dbInfo, new DriverManagerDataSource(objMap.get("url").toString(), objMap.get("username").toString(), objMap.get("password").toString()));
    }     

    // è®¾ç½®åˆ†åº“åˆ†è¡¨æ•°æ®æº
    DynamicDataSource dynamicDataSource = new DynamicDataSource();
    dynamicDataSource.setTargetDataSources(targetDataSources);
    // è®¾ç½®é»˜è®¤æ•°æ®æº
    dynamicDataSource.setDefaultTargetDataSource(new DriverManagerDataSource(defaultDataSourceConfig.get("url").toString(), defaultDataSourceConfig.get("username").toString(), defaultDataSourceConfig.get("password").toString()));

    return dynamicDataSource;
}
```

> æ•°æ®æºåˆ›å»ºå®Œæˆåå­˜æ”¾åˆ° `DynamicDataSource` ä¸­ï¼Œå®ƒæ˜¯ä¸€ä¸ªç»§æ‰¿äº† AbstractRoutingDataSource çš„å®ç°ç±»ï¼Œè¿™ä¸ªç±»é‡Œå¯ä»¥å­˜æ”¾å’Œè¯»å–ç›¸åº”çš„å…·ä½“è°ƒç”¨çš„æ•°æ®æºä¿¡æ¯ã€‚



#### åˆ‡é¢æ‹¦æˆª

```java
@Around("aopPoint() && @annotation(dbRouter)")
public Object doRouter(ProceedingJoinPoint jp, DBRouter dbRouter) throws Throwable {
    String dbKey = dbRouter.key();
    if (StringUtils.isBlank(dbKey)) throw new RuntimeException("annotation DBRouter key is nullï¼");

    // è®¡ç®—è·¯ç”±
    String dbKeyAttr = getAttrValue(dbKey, jp.getArgs());
    int size = dbRouterConfig.getDbCount() * dbRouterConfig.getTbCount();

    // æ‰°åŠ¨å‡½æ•°
    int idx = (size - 1) & (dbKeyAttr.hashCode() ^ (dbKeyAttr.hashCode() >>> 16));

    // åº“è¡¨ç´¢å¼•
    int dbIdx = idx / dbRouterConfig.getTbCount() + 1;
    int tbIdx = idx - dbRouterConfig.getTbCount() * (dbIdx - 1);   

    // è®¾ç½®åˆ° ThreadLocal
    DBContextHolder.setDBKey(String.format("%02d", dbIdx));
    DBContextHolder.setTBKey(String.format("%02d", tbIdx));
    logger.info("æ•°æ®åº“è·¯ç”± methodï¼š{} dbIdxï¼š{} tbIdxï¼š{}", getMethod(jp).getName(), dbIdx, tbIdx);
   
    // è¿”å›ç»“æœ
    try {
        return jp.proceed();
    } finally {
        DBContextHolder.clearDBKey();
        DBContextHolder.clearTBKey();
    }
}
```

> + ç®€åŒ–çš„æ ¸å¿ƒé€»è¾‘å®ç°ä»£ç å¦‚ä¸Šï¼Œé¦–å…ˆæˆ‘ä»¬æå–äº†åº“è¡¨ä¹˜ç§¯çš„æ•°é‡ï¼ŒæŠŠå®ƒå½“æˆ HashMap ä¸€æ ·çš„é•¿åº¦è¿›è¡Œä½¿ç”¨ã€‚
>
> + æ¥ä¸‹æ¥ä½¿ç”¨å’Œ HashMap ä¸€æ ·çš„æ‰°åŠ¨å‡½æ•°é€»è¾‘ï¼Œè®©æ•°æ®åˆ†æ•£çš„æ›´åŠ æ•£åˆ—ã€‚
> + å½“è®¡ç®—å®Œæ€»é•¿åº¦ä¸Šçš„ä¸€ä¸ªç´¢å¼•ä½ç½®åï¼Œè¿˜éœ€è¦æŠŠè¿™ä¸ªä½ç½®æŠ˜ç®—åˆ°åº“è¡¨ä¸­ï¼Œçœ‹çœ‹æ€»ä½“é•¿åº¦çš„ç´¢å¼•å› ä¸ºè½åˆ°å“ªä¸ªåº“å“ªä¸ªè¡¨ã€‚
> + æœ€åæ˜¯æŠŠè¿™ä¸ªè®¡ç®—çš„ç´¢å¼•ä¿¡æ¯å­˜æ”¾åˆ° ThreadLocal ä¸­ï¼Œç”¨äºä¼ é€’åœ¨æ–¹æ³•è°ƒç”¨è¿‡ç¨‹ä¸­å¯ä»¥æå–åˆ°ç´¢å¼•ä¿¡æ¯ã€‚



#### MyBatisæ‹¦æˆªå™¨å¤„ç†åˆ†åº“åˆ†è¡¨

é€šè¿‡æ‹¦æˆª SQL è¯­å¥åŠ¨æ€ä¿®æ”¹æ·»åŠ åˆ†è¡¨ä¿¡æ¯ï¼Œå†è®¾ç½®å› Mybatis æ‰§è¡Œ SQL ä¸­ã€‚

æ­¤å¤–å†å®Œå–„ä¸€äº›åˆ†åº“åˆ†è¡¨è·¯ç”±çš„æ“ä½œï¼Œæ¯”å¦‚é…ç½®é»˜è®¤çš„åˆ†åº“åˆ†è¡¨å­—æ®µä»¥åŠå•å­—æ®µå…¥å‚æ—¶é»˜è®¤å–æ­¤å­—æ®µä½œä¸ºè·¯ç”±å­—æ®µã€‚

```java
@Intercepts({@Signature(type = StatementHandler.class, method = "prepare", args = {Connection.class, Integer.class})})
public class DynamicMybatisPlugin implements Interceptor {


    private Pattern pattern = Pattern.compile("(from|into|update)[\\s]{1,}(\\w{1,})", Pattern.CASE_INSENSITIVE);

    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        // è·å–StatementHandler
        StatementHandler statementHandler = (StatementHandler) invocation.getTarget();
        MetaObject metaObject = MetaObject.forObject(statementHandler, SystemMetaObject.DEFAULT_OBJECT_FACTORY, SystemMetaObject.DEFAULT_OBJECT_WRAPPER_FACTORY, new DefaultReflectorFactory());
        MappedStatement mappedStatement = (MappedStatement) metaObject.getValue("delegate.mappedStatement");

        // è·å–è‡ªå®šä¹‰æ³¨è§£åˆ¤æ–­æ˜¯å¦è¿›è¡Œåˆ†è¡¨æ“ä½œ
        String id = mappedStatement.getId();
        String className = id.substring(0, id.lastIndexOf("."));
        Class<?> clazz = Class.forName(className);
        DBRouterStrategy dbRouterStrategy = clazz.getAnnotation(DBRouterStrategy.class);
        if (null == dbRouterStrategy || !dbRouterStrategy.splitTable()){
            return invocation.proceed();
        }

        // è·å–SQL
        BoundSql boundSql = statementHandler.getBoundSql();
        String sql = boundSql.getSql();

        // æ›¿æ¢SQLè¡¨å USER ä¸º USER_03
        Matcher matcher = pattern.matcher(sql);
        String tableName = null;
        if (matcher.find()) {
            tableName = matcher.group().trim();
        }
        assert null != tableName;
        String replaceSql = matcher.replaceAll(tableName + "_" + DBContextHolder.getTBKey());

        // é€šè¿‡åå°„ä¿®æ”¹SQLè¯­å¥
        Field field = boundSql.getClass().getDeclaredField("sql");
        field.setAccessible(true);
        field.set(boundSql, replaceSql);

        return invocation.proceed();
    }

}
```

å®ç° Interceptor æ¥å£çš„ intercept æ–¹æ³•ï¼Œè·å–StatementHandlerã€é€šè¿‡è‡ªå®šä¹‰æ³¨è§£åˆ¤æ–­æ˜¯å¦è¿›è¡Œåˆ†è¡¨æ“ä½œã€è·å–SQLå¹¶æ›¿æ¢SQLè¡¨å USER ä¸º USER_03ã€æœ€åé€šè¿‡åå°„ä¿®æ”¹SQLè¯­å¥

æ­¤å¤„ä¼šç”¨åˆ°æ­£åˆ™è¡¨è¾¾å¼æ‹¦æˆªå‡ºåŒ¹é…çš„sqlï¼Œ`(from|into|update)[\\s]{1,}(\\w{1,})`



## è§„åˆ™å¼•æ“é‡åŒ–äººç¾¤å‚ä¸æ´»åŠ¨

ä½¿ç”¨ç»„åˆæ¨¡å¼æ­å»ºç”¨äºé‡åŒ–äººç¾¤çš„è§„åˆ™å¼•æ“ï¼Œç”¨äºç”¨æˆ·å‚ä¸æ´»åŠ¨ä¹‹å‰ï¼Œé€šè¿‡è§„åˆ™å¼•æ“è¿‡æ»¤æ€§åˆ«ã€å¹´é¾„ã€é¦–å•æ¶ˆè´¹ã€æ¶ˆè´¹é‡‘é¢ã€å¿ å®ç”¨æˆ·ç­‰å„ç±»èº«ä»½æ¥é‡åŒ–å‡ºå…·ä½“å¯å‚ä¸çš„æŠ½å¥–æ´»åŠ¨ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼æ§åˆ¶è¿è¥æˆæœ¬å’Œç²¾ç»†åŒ–è¿è¥ã€‚



## é¢è¯•é¢˜ 

### CPUæˆ–è€…å†…å­˜é£™é«˜

+ äº‹æ•…çº§åˆ«ï¼šP0
+ äº‹æ•…åˆ¤è´£ï¼šè¥é”€æ´»åŠ¨æ¨å¹¿ç”¨æˆ·è¾ƒå¤šï¼Œå½±å“èŒƒå›´è¾ƒå¤§ï¼Œç ”å‘æ•´æ”¹ä»£ç å¹¶åšå¤ç›˜ã€‚
+ äº‹æ•…åç§°ï¼šç§’æ€æ–¹æ¡ˆç‹¬å ç«æ€å®ç°é—®é¢˜
+ äº‹æ•…ç°è±¡ï¼šçº¿ä¸Šç›‘æ§çªç„¶æŠ¥è­¦ï¼ŒCPUå ç”¨é«˜ï¼Œæ‹–å®æ•´ä¸ªæœåŠ¡ã€‚ç”¨æˆ·çœ‹åˆ°å¯ä»¥è´­ä¹°ï¼Œä½†åªè¦ä¸€ç‚¹ä¸‹å•å°±æ´»åŠ¨å¤ªç«çˆ†ï¼Œæ¢ä¸ªå°æ‰‹è¯•è¯•ã€‚é€ æˆäº†å¤§é‡å®¢è¯‰ï¼Œç´§æ€¥ä¸‹çº¿æ´»åŠ¨æ’æŸ¥ã€‚
+ äº‹æ•…æè¿°ï¼šè¿™ä¸ªä¸€ä¸ªå•†å“æ´»åŠ¨ç§’æ€çš„å®ç°æ–¹æ¡ˆï¼Œæœ€å¼€å§‹çš„è®¾è®¡æ˜¯åŸºäºä¸€ä¸ªæ´»åŠ¨å·Dè¿›è¡Œé”å®šï¼Œç§’æ€æ—¶é”å®šè¿™ä¸ªD,ç”¨æˆ·è´­ä¹°å®Œåå°±è¿›è¡Œé‡Šæ”¾ã€‚ä½†åœ¨å¤§é‡ç”¨æˆ·æŠ¢è´­æ—¶ï¼Œå‡ºç°äº†ç§’æ€åˆ†å¸ƒå¼é”åçš„ä¸šåŠ¡é€»è¾‘å¤„ç†ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œé‡Šæ”¾é”å¤±è´¥ã€‚å¯¼è‡´æ‰€æœ‰çš„ç”¨æˆ·éƒ½ä¸èƒ½å†æ‹¿åˆ°é”ï¼Œä¹Ÿå°±é€ æˆäº†æœ‰å•†å“ä½†ä¸èƒ½ä¸‹å•çš„é—®é¢˜ã€‚
+ äº‹æ•…å¤„ç†ï¼šä¼˜åŒ–ç‹¬å ç«æ€ä¸ºåˆ†æ®µé™æ€ï¼Œå°†æ´»åŠ¨ID+åº“å­˜ç¼–å·ä½œä¸ºåŠ¨æ€é”æ ‡è¯†ã€‚å½“å‰ç§’æ€çš„ç”¨æˆ·å¦‚æœå‘ç”Ÿé”å¤±è´¥é‚£ä¹ˆåé¢çš„ç”¨æˆ·å¯ä»¥ç»§ç»­ç§’æ€ä¸å—å½±å“ã€‚è€Œå¤±è´¥çš„é”ä¼šæœ‰workeriè¿›è¡Œè¡¥å¿æ¢å¤ï¼Œé‚£ä¹ˆæœ€ç»ˆä¼šé¿å…è¶…å–ä»¥åŠä¸èƒ½å”®å–ã€‚

 