# 项目笔记

## 项目部署

### 将项目停止

通过`ps -ef | grep java`找到java进程对应的PID，可以通过`netstat -anp | grep (PID)`命令查看对应PID的进程运行状态，最后通过`kill PID`来停止进程

### 启动项目

在项目目录下，执行当前目录的脚步文件

```
./deploy.sh &
```

就可以启动目录了，启动信息在当前目录下`nohup.out`文件中



## Tomcat性能调优

### 默认内嵌Tomcat配置

```
server.tomcat.accept-count：等待队列长度，默认100
server.tomcat.max-connections：最大可被连接数，默认10000
server.tomcat.max-threads：最大工作线程数，默认200
server.tomcat.min-spare-threads：最小工作线程数，默认10
```

默认配置下

+ 连接超过10000后出现拒接连接情况
+ 触发的请求超过200+100（等待队列中的请求）后拒接处理



可以通过修改application中tomcat容器配置进行调优：

<img src="https://notetuchuang-1305953527.cos.ap-chengdu.myqcloud.com/images/%E7%A7%92%E6%9D%80%E5%95%86%E5%9F%8E/Tomcat%E5%8F%82%E6%95%B0%E4%BF%AE%E6%94%B9.png" align="left" alt="Tomcat参数修改">



### 定制化内嵌Tomcat开发

```
keepAliveTimeOut：多少毫秒不响应断开keepalive
maxKeepAliveRequest：多少次请求后keepalive断开失效
```

在项目中添加配置类WebServerConfiguration定制Tomcat配置

```java
@Configuration
public class WebServerConfiguration implements WebServerFactoryCustomizer<ConfigurableWebServerFactory> {

    @Override
    public void customize(ConfigurableWebServerFactory factory) {
        // 使用工厂类定制化tomcat connector
        ((TomcatServletWebServerFactory) factory).addConnectorCustomizers(new TomcatConnectorCustomizer() {
            @Override
            public void customize(Connector connector) {
                Http11NioProtocol protocol = (Http11NioProtocol) connector.getProtocolHandler();
                
                // 定制化keepalive参数，设置30秒内没有请求，服务端自动断开keepalive连接
                protocol.setKeepAliveTimeout(30000);
                // 当客户端发送超过10000个请求，服务端自动断开keepalive连接
                protocol.setMaxKeepAliveRequests(10000);
            }
        });
    }
}
```

